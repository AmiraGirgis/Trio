var freeaps_determineBasal;(()=>{var e={2982:(e,r,t)=>{var a=t(3531);function o(e,r){r||(r=0);var t=Math.pow(10,r);return Math.round(e*t)/t}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}e.exports=function(e,r,t,i,s,l,d,u,m,c,g,h,v,B,b){var p=i.min_bg,f=B.overrideTarget;0!=f&&6!=f&&B.useOverride&&!i.temptargetSet&&(p=f);const M=B.smbIsOff,_=B.advancedSettings,x=B.isfAndCr,S=B.isf,y=B.cr,G=B.smbMinutes,C=B.uamMinutes;var w=h.useNewFormula,O=0,U=p,D=new Date;c&&(D=new Date(c));var T="",A="",R=B.currentTDD;const I=B.weightedAverage;var F=1,j=i.sens,E=i.carb_ratio;B.useOverride&&(F=B.overridePercentage/100,x?(j/=F,E/=F):(y&&(E/=F),S&&(j/=F)));const q=i.weightPercentage,W=B.average_total_data,P=Math.min(i.autosens_min,i.autosens_max),k=Math.max(i.autosens_min,i.autosens_max);(k==P||k<1||P>1)&&(w=!1,console.log("Dynamic ISF disabled due to current autosens settings"));const L=e.glucose,z=h.enableDynamicCR,N=h.adjustmentFactor,H=h.adjustmentFactorSigmoid,Z=h.sigmoid,$=p;var J,K=!1,Q="",V=1;W>0&&(V=I/W),V>1?(V=o(V=Math.min(V,i.autosens_max),2),i.autosens_max):V<1&&(V=o(V=Math.max(V,i.autosens_min),2),i.autosens_min),J=", Basal ratio: "+V,(i.high_temptarget_raises_sensitivity||i.exercise_mode)&&(K=!0),$>=118&&K&&(w=!1,Q="Dynamic ISF temporarily off due to a high temp target/exercising. Current min target: "+$);var X=", Dynamic ratios log: ",Y=", AF: "+(Z?H:N),ee="BG: "+L+" mg/dl ("+(.0555*L).toPrecision(2)+" mmol/l)",re="",te="";const ae=h.curve,oe=i.insulinPeakTime,ne=h.useCustomPeakTime;var ie=55,se=65;switch(ae){case"rapid-acting":se=65;break;case"ultra-rapid":se=50}ne?(ie=120-oe,console.log("Custom insulinpeakTime set to :"+oe+", insulinFactor: "+ie)):(ie=120-se,console.log("insulinFactor set to : "+ie)),tdd_before=R,q<1&&I>1&&(R=I,console.log("Using weighted TDD average: "+o(R,2)+" U, instead of past 24 h ("+o(tdd_before,2)+" U), weight: "+q),te=", Weighted TDD: "+o(R,2)+" U");var le="";if(w)if(Z){const e=P,r=k-e;var de=k-1;1==k&&(de=k+.01-1);const t=.0555*(L-p)*H*V+Math.log10(1/de-e/de)/Math.log10(Math.E);ue=r/(1+Math.exp(-t))+e,re=", Sigmoid function"}else{var ue=j*N*R*Math.log(L/ie+1)/1800;re=", Logarithmic formula"}var me=E;const ce=o(E,1);var ge="",he="";if(w&&R>0){if(ge=", Dynamic ISF/CR: On/",ue>k?(Q=", Dynamic ISF limited by autosens_max setting: "+k+" ("+o(ue,2)+"), ",he=", Autosens/Dynamic Limit: "+k+" ("+o(ue,2)+")",ue=k):ue<P&&(Q=", Dynamic ISF limited by autosens_min setting: "+P+" ("+o(ue,2)+"). ",he=", Autosens/Dynamic Limit: "+P+" ("+o(ue,2)+")",ue=P),z){ge+="On";var ve=". New Dynamic CR: "+o(E/=ue,1)+" g/U"}else ve=" CR: "+me+" g/U",ge+="Off";const e=j/ue;s.ratio=ue,le=". Using Sigmoid function, the autosens ratio has been adjusted with sigmoid factor to: "+o(s.ratio,2)+". New ISF = "+o(e,2)+" mg/dl ("+o(.0555*e,2)+" (mmol/l). CR adjusted from "+o(ce,2)+" to "+o(E,2),T+=X+ee+Y+re+(Q+=Z?le:", Dynamic autosens.ratio set to "+o(ue,2)+" with ISF: "+e.toPrecision(3)+" mg/dl/U ("+(.0555*e).toPrecision(3)+" mmol/l/U)")+ge+ve+te}else T+=X+"Dynamic Settings disabled";console.log(T),w||z?w&&i.tddAdjBasal?A+=ge+re+he+Y+J:w&&!i.tddAdjBasal&&(A+=ge+re+he+Y):A+="",.5!==i.smb_delivery_ratio&&(A+=", SMB Ratio: "+Math.min(i.smb_delivery_ratio,1)),""!==b&&"Nothing changed"!==b&&(A+=", Middleware: "+b);var Be={},be=new Date(D);if(void 0===i||void 0===i.current_basal)return Be.error="Error: could not get current basal rate",Be;var pe=a(i.current_basal,i)*F,fe=pe;B.useOverride&&(0==B.duration?console.log("Profile Override is active. Override "+o(100*F,0)+"%. Override Duration: Enabled indefinitely"):console.log("Profile Override is active. Override "+o(100*F,0)+"%. Override Expires in: "+B.duration+" min."));var Me,_e=new Date(e.date),xe=o((D-_e)/60/1e3,1),Se=e.glucose,ye=e.noise;Me=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var Ge=Math.min(e.delta,e.short_avgdelta),Ce=Math.min(e.short_avgdelta,e.long_avgdelta),we=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);if((Se<=10||38===Se||ye>=3)&&(Be.reason="CGM is calibrating, in ??? state, or noise is high"),Se>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&400!=Se&&"fakecgm"==e.device&&(console.error("CGM data is unchanged ("+n(Se,i)+"+"+n(e.delta,i)+") for 5m w/ "+n(e.short_avgdelta,i)+" mg/dL ~15m change & "+n(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")),xe>12||xe<-5?Be.reason="If current system time "+D+" is correct, then BG data is too old. The last BG data was read "+xe+"m ago at "+_e:0===e.short_avgdelta&&0===e.long_avgdelta&&400!=Se&&(e.last_cal&&e.last_cal<3?Be.reason="CGM was just calibrated":Be.reason="CGM data is unchanged ("+n(Se,i)+"+"+n(e.delta,i)+") for 5m w/ "+n(e.short_avgdelta,i)+" mg/dL ~15m change & "+n(e.long_avgdelta,i)+" mg/dL ~45m change"),400!=Se&&(Se<=10||38===Se||ye>=3||xe>12||xe<-5||0===e.short_avgdelta&&0===e.long_avgdelta))return r.rate>=fe?(Be.reason+=". Canceling high temp basal of "+r.rate,Be.deliverAt=be,Be.temp="absolute",Be.duration=0,Be.rate=0,Be):0===r.rate&&r.duration>30?(Be.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",Be.deliverAt=be,Be.temp="absolute",Be.duration=30,Be.rate=0,Be):(Be.reason+=". Temp "+r.rate+" <= current basal "+fe+"U/hr; doing nothing. ",Be);var Oe,Ue,De,Te,Ae=i.max_iob;if(void 0!==p&&(Ue=p),void 0!==i.max_bg&&(De=p),void 0!==i.enableSMB_high_bg_target&&(Te=i.enableSMB_high_bg_target),void 0===p)return Be.error="Error: could not determine target_bg. ",Be;Oe=p;var Re,Ie=i.exercise_mode||i.high_temptarget_raises_sensitivity,Fe=100;if(Re=i.half_basal_exercise_target,Ie&&i.temptargetSet&&Oe>Fe||i.low_temptarget_lowers_sensitivity&&i.temptargetSet&&Oe<Fe){var je=Re-Fe;sensitivityRatio=je*(je+Oe-Fe)<=0?i.autosens_max:je/(je+Oe-Fe),sensitivityRatio=Math.min(sensitivityRatio,i.autosens_max),sensitivityRatio=o(sensitivityRatio,2),process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+Oe+"; ")}else void 0!==s&&s&&(sensitivityRatio=s.ratio,0===f||6===f||f===i.min_bg||i.temptargetSet||(Oe=f,console.log("Current Override Profile Target: "+n(f,i)+" "+i.out_units)),process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(i.temptargetSet&&Oe<Fe&&w&&L>=Oe&&sensitivityRatio<ue&&(s.ratio=ue*(Fe/Oe),s.ratio=Math.min(s.ratio,i.autosens_max),sensitivityRatio=o(s.ratio,2),console.log("Dynamic ratio increased from "+o(ue,2)+" to "+o(s.ratio,2)+" due to a low temp target ("+Oe+").")),sensitivityRatio&&!w?(fe=i.current_basal*F*sensitivityRatio,(fe=a(fe,i))!==pe?process.stderr.write("Adjusting basal from "+pe+" to "+fe+"; "):process.stderr.write("Basal unchanged: "+fe+"; ")):w&&i.tddAdjBasal&&(fe=i.current_basal*V*F,fe=a(fe,i),W>0&&(process.stderr.write("TDD-adjustment of basals activated, using tdd24h_14d_Ratio "+o(V,2)+", TDD 24h = "+o(tdd_before,2)+"U, Weighted average TDD = "+o(I,2)+"U, (Weight percentage = "+q+"), Total data of TDDs (up to 14 days) average = "+o(W,2)+"U. "),fe!==pe*F?process.stderr.write("Adjusting basal from "+pe*F+" U/h to "+fe+" U/h; "):process.stderr.write("Basal unchanged: "+fe+" U/h; "))),i.temptargetSet);else if(void 0!==s&&s&&(i.sensitivity_raises_target&&s.ratio<1||i.resistance_lowers_target&&s.ratio>1)){Ue=o((Ue-60)/s.ratio)+60,De=o((De-60)/s.ratio)+60;var Ee=o((Oe-60)/s.ratio)+60;Oe===(Ee=Math.max(80,Ee))?process.stderr.write("target_bg unchanged: "+n(Ee,i)+"; "):process.stderr.write("target_bg from "+n(Ee,i)+" to "+n(Ee,i)+"; "),Oe=Ee}var qe=n(Oe,i);Oe!=p&&(qe=0!==f&&6!==f&&f!==Oe?n(p,i)+"→"+n(f,i)+"→"+n(Oe,i):n(p,i)+"→"+n(Oe,i));var We=200,Pe=200,ke=200;if(e.noise>=2){var Le=Math.max(1.1,i.noisyCGMTargetMultiplier);Math.min(250,i.maxRaw),We=o(Math.min(200,Ue*Le)),Pe=o(Math.min(200,Oe*Le)),ke=o(Math.min(200,De*Le)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+n(Ee,i)+" to "+n(Pe,i)+"; "),Ue=We,Oe=Pe,De=ke}U=Ue-.5*(Ue-40),U=Math.min(Math.max(i.threshold_setting,U,60),120),console.error(`Threshold set to ${n(U,i)}`);var ze="",Ne=(o(j,1),j);if(void 0!==s&&s&&((Ne=o(Ne=j/sensitivityRatio,1))!==j?process.stderr.write("ISF from "+n(j,i)+" to "+n(Ne,i)):process.stderr.write("ISF unchanged: "+n(Ne,i)),ze+="Autosens ratio: "+o(sensitivityRatio,2)+", ISF: "+n(j,i)+"→"+n(Ne,i)),console.error("CR:"+E),void 0===t)return Be.error="Error: iob_data undefined. ",Be;var He,Ze=t;if(t.length,t.length>1&&(t=Ze[0]),void 0===t.activity||void 0===t.iob)return Be.error="Error: iob_data missing some property. ",Be;var $e=((He=void 0!==t.lastTemp?o((new Date(D).getTime()-t.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+He+"m, tempModulus:"+$e+"m"),Be.temp="absolute",Be.deliverAt=be,u&&r&&t.lastTemp&&r.rate!==t.lastTemp.rate&&He>10&&r.duration)return Be.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+t.lastTemp.rate+" from pumphistory; canceling temp",d.setTempBasal(0,0,i,Be,r);if(r&&t.lastTemp&&r.duration>0){var Je=He-t.lastTemp.duration;if(Je>5&&He>10)return Be.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Je+"m ago; canceling temp",d.setTempBasal(0,0,i,Be,r)}var Ke=o(-t.activity*Ne*5,2),Qe=o(6*(Ge-Ke));Qe<0&&(Qe=o(6*(Ce-Ke)))<0&&(Qe=o(6*(e.long_avgdelta-Ke)));var Ve,Xe=(Ve=t.iob>0?o(Se-t.iob*Ne):o(Se-t.iob*Math.min(Ne,j)))+Qe;if(void 0===Xe||isNaN(Xe))return Be.error="Error: could not calculate eventualBG. Sensitivity: "+Ne+" Deviation: "+Qe,Be;var Ye,er,rr=function(e,r,t){return o(t+(e-r)/24,1)}(Oe,Xe,Ke);Be={temp:"absolute",bg:Se,tick:Me,eventualBG:Xe,insulinReq:0,reservoir:m,deliverAt:be,sensitivityRatio,CR:o(E,1),current_target:Oe,insulinForManualBolus:O,manualBolusErrorString:0,minDelta:Ge,expectedDelta:rr,minGuardBG:er,minPredBG:Ye,threshold:n(U,i)};var tr=[],ar=[],or=[],nr=[];tr.push(Se),ar.push(Se),nr.push(Se),or.push(Se);let ir=!1;M?(console.error("SMBs are always off."),ir=!1):ir=function(e,r,t,a,o,i,s,l){if(s.smbIsScheduledOff){let e=new Date(l.getHours()),r=s.start,t=s.end;if(r<t&&e>=r&&e<t)return console.error("SMB disabled: current time is in SMB disabled scheduled"),!1;if(r>t&&(e>=r||e<t))return console.error("SMB disabled: current time is in SMB disabled scheduled"),!1;if(0==r&&0==t)return console.error("SMB disabled: current time is in SMB disabled scheduled"),!1;if(r==t&&e==r)return console.error("SMB disabled: current time is in SMB disabled scheduled"),!1}return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===t.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):400==a?(console.error("Invalid CGM (HIGH). SMBs disabled."),!1):!0===e.enableSMB_always?(t.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&t.mealCOB?(t.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of "+t.mealCOB),!0):!0===e.enableSMB_after_carbs&&t.carbs?(t.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(t.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&a>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",a," | High BG ",i),t.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(i,u,l,Se,Oe,Te,B,D);var sr,lr=i.enableUAM,dr=0;dr=o(Ge-Ke,1);var ur=o(Ge-Ke,1);csf=Ne/E,console.error("profile.sens:"+n(j,i)+", sens:"+n(Ne,i)+", CSF:"+o(csf,1));var mr=o(30*csf*5/60,1);dr>mr&&(console.error("Limiting carb impact from "+dr+" to "+mr+"mg/dL/5m (30g/h)"),dr=mr);var cr=3;sensitivityRatio&&(cr/=sensitivityRatio);var gr=cr;if(l.carbs){cr=Math.max(cr,l.mealCOB/20);var hr=o((new Date(D).getTime()-l.lastCarbTime)/6e4),vr=(l.carbs-l.mealCOB)/l.carbs;gr=o(gr=cr+1.5*hr/60,1),console.error("Last carbs "+hr+" minutes ago; remainingCATime:"+gr+"hours; "+o(100*vr,1)+"% carbs absorbed")}var Br=Math.max(0,dr/5*60*gr/2)/csf,br=90,pr=1;i.remainingCarbsCap&&(br=Math.min(90,i.remainingCarbsCap)),i.remainingCarbsFraction&&(pr=Math.min(1,i.remainingCarbsFraction));var fr=1-pr,Mr=Math.max(0,l.mealCOB-Br-l.carbs*fr),_r=(Mr=Math.min(br,Mr))*csf*5/60/(gr/2),xr=o(l.slopeFromMaxDeviation,2),Sr=o(l.slopeFromMinDeviation,2),yr=Math.min(xr,-Sr/3);sr=0===dr?0:Math.min(60*gr/5/2,Math.max(0,l.mealCOB*csf/dr)),console.error("Carb Impact:"+dr+"mg/dL per 5m; CI Duration:"+o(5*sr/60*2,1)+"hours; remaining CI ("+gr/2+"h peak):"+o(_r,1)+"mg/dL per 5m");var Gr,Cr,wr,Or,Ur=999,Dr=999,Tr=999,Ar=999,Rr=999,Ir=999,Fr=999,jr=Xe,Er=Se,qr=Se,Wr=0,Pr=[],kr=[];try{Ze.forEach((function(e){var r=o(-e.activity*Ne*5,2),t=o(-e.iobWithZeroTemp.activity*Ne*5,2),a=Ve,n=dr*(1-Math.min(1,ar.length/12));!0===(w&&!Z)?(jr=ar[ar.length-1]+o(-e.activity*(1800/(R*N*Math.log(Math.max(ar[ar.length-1],39)/ie+1)))*5,2)+n,a=nr[nr.length-1]+o(-e.iobWithZeroTemp.activity*(1800/(R*N*Math.log(Math.max(nr[nr.length-1],39)/ie+1)))*5,2),console.log("Dynamic ISF (Logarithmic Formula) )adjusted predictions for IOB and ZT: IOBpredBG: "+o(jr,2)+" , ZTpredBG: "+o(a,2))):(jr=ar[ar.length-1]+r+n,a=nr[nr.length-1]+t);var i=Math.max(0,Math.max(0,dr)*(1-tr.length/Math.max(2*sr,1))),s=Math.min(tr.length,12*gr-tr.length),l=Math.max(0,s/(gr/2*12)*_r);Pr.push(o(l,0)),kr.push(o(i,0)),COBpredBG=tr[tr.length-1]+r+Math.min(0,n)+i+l;var d=Math.max(0,ur+or.length*yr),u=Math.max(0,ur*(1-or.length/Math.max(36,1))),m=Math.min(d,u);m>0&&(Wr=o(5*(or.length+1)/60,1)),!0===(w&&!Z)?(UAMpredBG=or[or.length-1]+o(-e.activity*(1800/(R*N*Math.log(Math.max(or[or.length-1],39)/ie+1)))*5,2)+Math.min(0,n)+m,console.log("Dynamic ISF (Logarithmic Formula) adjusted prediction for UAM: UAMpredBG: "+o(UAMpredBG,2))):UAMpredBG=or[or.length-1]+r+Math.min(0,n)+m,ar.length<48&&ar.push(jr),tr.length<48&&tr.push(COBpredBG),or.length<48&&or.push(UAMpredBG),nr.length<48&&nr.push(a),COBpredBG<Ar&&(Ar=o(COBpredBG)),UAMpredBG<Rr&&(Rr=o(UAMpredBG)),jr<Ir&&(Ir=o(jr)),a<Fr&&(Fr=o(a)),ar.length>18&&jr<Ur&&(Ur=o(jr)),jr>Er&&(Er=jr),(sr||_r>0)&&tr.length>18&&COBpredBG<Dr&&(Dr=o(COBpredBG)),(sr||_r>0)&&COBpredBG>Er&&(qr=COBpredBG),lr&&or.length>12&&UAMpredBG<Tr&&(Tr=o(UAMpredBG)),lr&&UAMpredBG>Er&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}l.mealCOB&&(console.error("predCIs (mg/dL/5m):"+kr.join(" ")),console.error("remainingCIs:      "+Pr.join(" "))),Be.predBGs={},ar.forEach((function(e,r,t){t[r]=o(Math.min(401,Math.max(39,e)))}));for(var Lr=ar.length-1;Lr>12&&ar[Lr-1]===ar[Lr];Lr--)ar.pop();for(Be.predBGs.IOB=ar,Cr=o(ar[ar.length-1]),nr.forEach((function(e,r,t){t[r]=o(Math.min(401,Math.max(39,e)))})),Lr=nr.length-1;Lr>6&&!(nr[Lr-1]>=nr[Lr]||nr[Lr]<=Oe);Lr--)nr.pop();if(Be.predBGs.ZT=nr,o(nr[nr.length-1]),l.mealCOB>0&&(dr>0||_r>0)){for(tr.forEach((function(e,r,t){t[r]=o(Math.min(1500,Math.max(39,e)))})),Lr=tr.length-1;Lr>12&&tr[Lr-1]===tr[Lr];Lr--)tr.pop();Be.predBGs.COB=tr,wr=o(tr[tr.length-1]),Xe=Math.max(Xe,o(tr[tr.length-1])),console.error("COBpredBG: "+o(tr[tr.length-1]))}if(dr>0||_r>0){if(lr){for(or.forEach((function(e,r,t){t[r]=o(Math.min(401,Math.max(39,e)))})),Lr=or.length-1;Lr>12&&or[Lr-1]===or[Lr];Lr--)or.pop();Be.predBGs.UAM=or,Or=o(or[or.length-1]),or[or.length-1]&&(Xe=Math.max(Xe,o(or[or.length-1])))}Be.eventualBG=Xe}console.error("UAM Impact:"+ur+"mg/dL per 5m; UAM Duration:"+Wr+"hours"),Ur=Math.max(39,Ur),Dr=Math.max(39,Dr),Tr=Math.max(39,Tr),Ye=o(Ur);var zr=l.mealCOB/l.carbs;Gr=o(Tr<999&&Dr<999?(1-zr)*UAMpredBG+zr*COBpredBG:Dr<999?(jr+COBpredBG)/2:Tr<999?(jr+UAMpredBG)/2:jr),Fr>Gr&&(Gr=Fr),er=o(er=sr||_r>0?lr?zr*Ar+(1-zr)*Rr:Ar:lr?Rr:Ir);var Nr=Tr;if(Fr<U)Nr=(Tr+Fr)/2;else if(Fr<Oe){var Hr=(Fr-U)/(Oe-U);Nr=(Tr+(Tr*Hr+Fr*(1-Hr)))/2}else Fr>Tr&&(Nr=(Tr+Fr)/2);if(Nr=o(Nr),l.carbs)if(!lr&&Dr<999)Ye=o(Math.max(Ur,Dr));else if(Dr<999){var Zr=zr*Dr+(1-zr)*Nr;Ye=o(Math.max(Ur,Dr,Zr))}else Ye=lr?Nr:er;else lr&&(Ye=o(Math.max(Ur,Nr)));Ye=Math.min(Ye,Gr),process.stderr.write("minPredBG: "+Ye+" minIOBPredBG: "+Ur+" minZTGuardBG: "+Fr),Dr<999&&process.stderr.write(" minCOBPredBG: "+Dr),Tr<999&&process.stderr.write(" minUAMPredBG: "+Tr),console.error(" avgPredBG:"+Gr+" COB/Carbs:"+l.mealCOB+"/"+l.carbs),qr>Se&&(Ye=Math.min(Ye,qr)),Be.COB=l.mealCOB,Be.IOB=t.iob,Be.BGI=n(Ke,i),Be.deviation=n(Qe,i),Be.ISF=n(Ne,i),Be.CR=o(E,1),Be.target_bg=n(Oe,i),Be.current_target=o(Oe,0);var $r=Be.CR;ce!=Be.CR&&($r=ce+"→"+Be.CR),Be.reason=ze+", COB: "+Be.COB+", Dev: "+Be.deviation+", BGI: "+Be.BGI+", CR: "+$r+", Target: "+qe+", minPredBG "+n(Ye,i)+", minGuardBG "+n(er,i)+", IOBpredBG "+n(Cr,i),wr>0&&(Be.reason+=", COBpredBG "+n(wr,i)),Or>0&&(Be.reason+=", UAMpredBG "+n(Or,i)),Be.reason+=A,Be.reason+="; ";var Jr=Ve;Jr<40&&(Jr=Math.min(er,Jr));var Kr,Qr=U-Jr,Vr=240,Xr=240;if(l.mealCOB>0&&(dr>0||_r>0)){for(Lr=0;Lr<tr.length;Lr++)if(tr[Lr]<Ue){Vr=5*Lr;break}for(Lr=0;Lr<tr.length;Lr++)if(tr[Lr]<U){Xr=5*Lr;break}}else{for(Lr=0;Lr<ar.length;Lr++)if(ar[Lr]<Ue){Vr=5*Lr;break}for(Lr=0;Lr<ar.length;Lr++)if(ar[Lr]<U){Xr=5*Lr;break}}ir&&er<U&&(console.error("minGuardBG "+n(er,i)+" projected below "+n(U,i)+" - disabling SMB"),Be.manualBolusErrorString=1,Be.minGuardBG=er,Be.insulinForManualBolus=o((Be.eventualBG-Be.target_bg)/Ne,2),ir=!1),void 0===i.maxDelta_bg_threshold&&(Kr=.2),void 0!==i.maxDelta_bg_threshold&&(Kr=Math.min(i.maxDelta_bg_threshold,.4)),we>Kr*Se&&(console.error("maxDelta "+n(we,i)+" > "+100*Kr+"% of BG "+n(Se,i)+" - disabling SMB"),Be.reason+="maxDelta "+n(we,i)+" > "+100*Kr+"% of BG "+n(Se,i)+" - SMB disabled!, ",ir=!1),console.error("BG projected to remain above "+n(Ue,i)+" for "+Vr+"minutes"),(Xr<240||Vr<60)&&console.error("BG projected to remain above "+n(U,i)+" for "+Xr+"minutes");var Yr=Xr,et=i.current_basal*F*Ne*Yr/60,rt=Math.max(0,l.mealCOB-.25*l.carbs),tt=(Qr-et)/csf-rt;et=o(et),tt=o(tt),console.error("naive_eventualBG:",Ve,"bgUndershoot:",Qr,"zeroTempDuration:",Yr,"zeroTempEffect:",et,"carbsReq:",tt),"Could not parse clock data"==l.reason?console.error("carbsReq unknown: Could not parse clock data"):tt>=i.carbsReqThreshold&&Xr<=45&&(Be.carbsReq=tt,Be.reason+=tt+" add'l carbs req w/in "+Xr+"m; ");var at=0;if(Se<U&&t.iob<-i.current_basal*F*20/60&&Ge>0&&Ge>rr)Be.reason+="IOB "+t.iob+" < "+o(-i.current_basal*F*20/60,2),Be.reason+=" and minDelta "+n(Ge,i)+" > expectedDelta "+n(rr,i)+"; ";else if(Se<U||er<U)return Be.reason+="minGuardBG "+n(er,i)+"<"+n(U,i),Qr=Oe-er,er<U&&(Be.manualBolusErrorString=2,Be.minGuardBG=er),Be.insulinForManualBolus=o((Xe-Oe)/Ne,2),at=o(Qr/Ne*60/i.current_basal*F),at=30*o(at/30),at=Math.min(120,Math.max(30,at)),d.setTempBasal(0,at,i,Be,r);if(i.skip_neutral_temps&&Be.deliverAt.getMinutes()>=55){if(!ir)return Be.reason+="; Canceling temp at "+(60-Be.deliverAt.getMinutes())+"min before turn of the hour to avoid beeping of MDT. SMB are disabled anyways.",d.setTempBasal(0,0,i,Be,r);console.error(60-Be.deliverAt.getMinutes()+"min before turn of the hour, but SMB's are enabled - not skipping neutral temps.")}var ot=0,nt=fe,it=0;if(Xe<Ue){if(Be.reason+="Eventual BG "+n(Xe,i)+" < "+n(Ue,i),Ge>rr&&Ge>0&&!tt)return Ve<40?(Be.reason+=", naive_eventualBG < 40. ",d.setTempBasal(0,30,i,Be,r)):(e.delta>Ge?Be.reason+=", but Delta "+n(Me,i)+" > expectedDelta "+n(rr,i):Be.reason+=", but Min. Delta "+Ge.toFixed(2)+" > Exp. Delta "+n(rr,i),r.duration>15&&a(fe,i)===a(r.rate,i)?(Be.reason+=", temp "+r.rate+" ~ req "+fe+"U/hr. ",Be):(Be.reason+="; setting current basal of "+fe+" as temp. ",d.setTempBasal(fe,30,i,Be,r)));ot=o(ot=2*Math.min(0,(Xe-Oe)/Ne),2);var st=Math.min(0,(Ve-Oe)/Ne);st=o(st,2),Ge<0&&Ge>rr&&(ot=o(ot*(Ge/rr),2)),nt=a(nt=fe+2*ot,i),it=r.duration*(r.rate-fe)/60;var lt=Math.min(ot,st);if(console.log("naiveInsulinReq:"+st),it<lt-.3*fe)return Be.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",d.setTempBasal(nt,30,i,Be,r);if(void 0!==r.rate&&r.duration>5&&nt>=.8*r.rate)return Be.reason+=", temp "+r.rate+" ~< req "+nt+"U/hr. ",Be;if(nt<=0){if((at=o((Qr=Oe-Ve)/Ne*60/i.current_basal*F))<0?at=0:(at=30*o(at/30),at=Math.min(120,Math.max(0,at))),at>0)return Be.reason+=", setting "+at+"m zero temp. ",d.setTempBasal(nt,at,i,Be,r)}else Be.reason+=", setting "+nt+"U/hr. ";return d.setTempBasal(nt,30,i,Be,r)}if(Ge<rr&&(Be.minDelta=Ge,Be.expectedDelta=rr,(rr-Ge>=2||rr+-1*Ge>=2)&&(Be.manualBolusErrorString=Ge>=0&&rr>0?3:Ge<0&&rr<=0||Ge<0&&rr>=0?4:5),Be.insulinForManualBolus=o((Be.eventualBG-Be.target_bg)/Ne,2),!u||!ir))return e.delta<Ge?Be.reason+="Eventual BG "+n(Xe,i)+" > "+n(Ue,i)+" but Delta "+n(Me,i)+" < Exp. Delta "+n(rr,i):Be.reason+="Eventual BG "+n(Xe,i)+" > "+n(Ue,i)+" but Min. Delta "+Ge.toFixed(2)+" < Exp. Delta "+n(rr,i),r.duration>15&&a(fe,i)===a(r.rate,i)?(Be.reason+=", temp "+r.rate+" ~ req "+fe+"U/hr. ",Be):(Be.reason+="; setting current basal of "+fe+" as temp. ",d.setTempBasal(fe,30,i,Be,r));if(Math.min(Xe,Ye)<De&&(Ye<Ue&&Xe>Ue&&(Be.manualBolusErrorString=6,Be.insulinForManualBolus=o((Be.eventualBG-Be.target_bg)/Ne,2),Be.minPredBG=Ye),!u||!ir))return Be.reason+=n(Xe,i)+"-"+n(Ye,i)+" in range: no temp required",r.duration>15&&a(fe,i)===a(r.rate,i)?(Be.reason+=", temp "+r.rate+" ~ req "+fe+"U/hr. ",Be):(Be.reason+="; setting current basal of "+fe+" as temp. ",d.setTempBasal(fe,30,i,Be,r));if(Xe>=De&&(Be.reason+="Eventual BG "+n(Xe,i)+" >= "+n(De,i)+", ",Xe>De&&(Be.insulinForManualBolus=o((Xe-Oe)/Ne,2))),t.iob>Ae)return Be.reason+="IOB "+o(t.iob,2)+" > max_iob "+Ae,r.duration>15&&a(fe,i)===a(r.rate,i)?(Be.reason+=", temp "+r.rate+" ~ req "+fe+"U/hr. ",Be):(Be.reason+="; setting current basal of "+fe+" as temp. ",d.setTempBasal(fe,30,i,Be,r));ot=o((Math.min(Ye,Xe)-Oe)/Ne,2),O=o((Xe-Oe)/Ne,2),ot>Ae-t.iob?(console.error("SMB limited by maxIOB: "+Ae-t.iob+" (. insulinReq: "+ot+" U)"),Be.reason+="max_iob "+Ae+", ",ot=Ae-t.iob):console.error("SMB not limited by maxIOB ( insulinReq: "+ot+" U)."),O>Ae-t.iob?(console.error("Ev. Bolus limited by maxIOB: "+Ae-t.iob+" (. insulinForManualBolus: "+O+" U)"),Be.reason+="max_iob "+Ae+", "):console.error("Ev. Bolus would not be limited by maxIOB ( insulinForManualBolus: "+O+" U)."),nt=a(nt=fe+2*ot,i),ot=o(ot,3),Be.insulinReq=ot;var dt=o((new Date(D).getTime()-t.lastBolusTime)/6e4,1);if(u&&ir&&Se>U){var ut=30;void 0!==i.maxSMBBasalMinutes&&(ut=i.maxSMBBasalMinutes);var mt=30;void 0!==i.maxUAMSMBBasalMinutes&&(mt=i.maxUAMSMBBasalMinutes),B.useOverride&&_&&G!==ut&&(console.error("SMB Max Minutes - setting overriden from "+ut+" to "+G),ut=G),B.useOverride&&_&&C!==mt&&(console.error("UAM Max Minutes - setting overriden from "+mt+" to "+C),mt=C);var ct=o(l.mealCOB/E,3),gt=0;void 0===ut?(gt=o(i.current_basal*F*30/60,1),console.error("smbMinutesSetting undefined: defaulting to 30m"),ot>gt&&console.error("SMB limited by maxBolus: "+gt+" ( "+ot+" U)")):t.iob>ct&&t.iob>0?(console.error("IOB"+t.iob+"> COB"+l.mealCOB+"; mealInsulinReq ="+ct),mt?(console.error("maxUAMSMBBasalMinutes: "+mt+", profile.current_basal: "+i.current_basal*F),gt=o(i.current_basal*F*mt/60,1)):(console.error("maxUAMSMBBasalMinutes undefined: defaulting to 30m"),gt=o(i.current_basal*F*30/60,1)),ot>gt?console.error("SMB limited by maxUAMSMBBasalMinutes [ "+mt+"m ]: "+gt+"U ( "+ot+"U )"):console.error("SMB is not limited by maxUAMSMBBasalMinutes. ( insulinReq: "+ot+"U )")):(console.error(".maxSMBBasalMinutes: "+ut+", profile.current_basal: "+i.current_basal*F),ot>(gt=o(i.current_basal*F*ut/60,1))?console.error("SMB limited by maxSMBBasalMinutes: "+ut+"m ]: "+gt+"U ( insulinReq: "+ot+"U )"):console.error("SMB is not limited by maxSMBBasalMinutes. ( insulinReq: "+ot+"U )"));var ht=i.bolus_increment,vt=1/ht,Bt=Math.min(i.smb_delivery_ratio,1);.5!=Bt&&console.error("SMB Delivery Ratio changed from default 0.5 to "+o(Bt,2));var bt=Math.min(ot*Bt,gt);bt=Math.floor(bt*vt)/vt,at=o((Oe-(Ve+Ur)/2)/Ne*60/i.current_basal*F),ot>0&&bt<ht&&(at=0);var pt=0;at<=0?at=0:at>=30?(at=30*o(at/30),at=Math.min(60,Math.max(0,at))):(pt=o(fe*at/30,2),at=30),Be.reason+=" insulinReq "+ot,bt>=gt&&(Be.reason+="; maxBolus "+gt),at>0&&(Be.reason+="; setting "+at+"m low temp of "+pt+"U/h"),Be.reason+=". ";var ft=3;i.SMBInterval&&(ft=Math.min(10,Math.max(1,i.SMBInterval)));var Mt=o(ft-dt,0),_t=o(60*(ft-dt),0)%60;if(console.error("naive_eventualBG "+Ve+","+at+"m "+pt+"U/h temp needed; last bolus "+dt+"m ago; maxBolus: "+gt),dt>ft?bt>0&&(Be.units=bt,Be.reason+="Microbolusing "+bt+"U. "):Be.reason+="Waiting "+Mt+"m "+_t+"s to microbolus again. ",at>0)return Be.rate=pt,Be.duration=at,Be}var xt=d.getMaxSafeBasal(i);return 400==Se?d.setTempBasal(i.current_basal,30,i,Be,r):(nt>xt&&(Be.reason+="adj. req. rate: "+nt+" to maxSafeBasal: "+o(xt,2)+", ",nt=a(xt,i)),(it=r.duration*(r.rate-fe)/60)>=2*ot?(Be.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+nt+"U/hr. ",d.setTempBasal(nt,30,i,Be,r)):void 0===r.duration||0===r.duration?(Be.reason+="no temp, setting "+nt+"U/hr. ",d.setTempBasal(nt,30,i,Be,r)):r.duration>5&&a(nt,i)<=a(r.rate,i)?(Be.reason+="temp "+r.rate+" >~ req "+nt+"U/hr. ",Be):(Be.reason+="temp "+r.rate+"<"+nt+"U/hr. ",d.setTempBasal(nt,30,i,Be,r)))}},3531:(e,r,t)=>{var a=t(2296);e.exports=function(e,r){var t=20;return void 0!==r&&"string"==typeof r.model&&(a(r.model,"54")||a(r.model,"23"))&&(t=40),e<1?Math.round(e*t)/t:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},1873:(e,r,t)=>{var a=t(9325).Symbol;e.exports=a},4932:e=>{e.exports=function(e,r){for(var t=-1,a=null==e?0:e.length,o=Array(a);++t<a;)o[t]=r(e[t],t,e);return o}},7133:e=>{e.exports=function(e,r,t){return e==e&&(void 0!==t&&(e=e<=t?e:t),void 0!==r&&(e=e>=r?e:r)),e}},2552:(e,r,t)=>{var a=t(1873),o=t(659),n=t(9350),i=a?a.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},7556:(e,r,t)=>{var a=t(1873),o=t(4932),n=t(6449),i=t(4394),s=a?a.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var t=r+"";return"0"==t&&1/r==-1/0?"-0":t}},4128:(e,r,t)=>{var a=t(1800),o=/^\s+/;e.exports=function(e){return e?e.slice(0,a(e)+1).replace(o,""):e}},4840:(e,r,t)=>{var a="object"==typeof t.g&&t.g&&t.g.Object===Object&&t.g;e.exports=a},659:(e,r,t)=>{var a=t(1873),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=a?a.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),t=e[s];try{e[s]=void 0;var a=!0}catch(e){}var o=i.call(e);return a&&(r?e[s]=t:delete e[s]),o}},9350:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},9325:(e,r,t)=>{var a=t(4840),o="object"==typeof self&&self&&self.Object===Object&&self,n=a||o||Function("return this")();e.exports=n},1800:e=>{var r=/\s/;e.exports=function(e){for(var t=e.length;t--&&r.test(e.charAt(t)););return t}},2296:(e,r,t)=>{var a=t(7133),o=t(7556),n=t(1489),i=t(3222);e.exports=function(e,r,t){e=i(e),r=o(r);var s=e.length,l=t=void 0===t?s:a(n(t),0,s);return(t-=r.length)>=0&&e.slice(t,l)==r}},6449:e=>{var r=Array.isArray;e.exports=r},3805:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},4394:(e,r,t)=>{var a=t(2552),o=t(346);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==a(e)}},7400:(e,r,t)=>{var a=t(6993),o=1/0;e.exports=function(e){return e?(e=a(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},1489:(e,r,t)=>{var a=t(7400);e.exports=function(e){var r=a(e),t=r%1;return r==r?t?r-t:r:0}},6993:(e,r,t)=>{var a=t(4128),o=t(3805),n=t(4394),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=a(e);var t=s.test(e);return t||l.test(e)?d(e.slice(2),t?2:8):i.test(e)?NaN:+e}},3222:(e,r,t)=>{var a=t(7556);e.exports=function(e){return null==e?"":a(e)}}},r={};function t(a){var o=r[a];if(void 0!==o)return o.exports;var n=r[a]={exports:{}};return e[a](n,n.exports,t),n.exports}t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var a=t(2982);freeaps_determineBasal=a})();